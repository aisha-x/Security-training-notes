# LetsDefend: Dynamic Malware Analysis Summary

# **What will you have learned at the end of the training?**

**Especially, Tier 1 level SOC analysts frequently make use of dynamic malware analysis method in their daily work routine. “Introduction to Dynamic Malware Analysis” training has been created in order to have the necessary foundations about this method.
Following topics will be taught throughout the training;**

- **What the dynamic malware analysis is,**
- **Tools and software that are needed to be able to analyze.**
- **Creating a Virtual Machine for dynamic malware analysis,**
- **What to consider in dynamic malware analysis,**
- **How to bypass some anti-malware analysis methods,**

# **1- What is Dynamic Malware Analysis?**

**Dynamic Malware Analysis**

- Runs malware in a **secure, isolated environment** to observe behavior (e.g., network, file activity).
- **Faster** than static analysis and commonly used by SOC analysts.
- **Sandboxes** automate the process and generate reports.

**Advantages**

- Faster results compared to static analysis.
- Supports automation via sandboxes.
- Easier for beginners; requires less technical knowledge.

**Disadvantages**

- Cannot reveal full malware functionality (behavior may differ across systems).
- Ineffective against advanced malware unless combined with static analysis.

# **2- Importance of Dynamic Malware Analysis for SOC Analysts**

- Malware analysis is a **core SOC task**; analysts deal with suspicious files daily.
- **Dynamic vs. Static Analysis:** Both are complementary, not substitutes.
- **Why Dynamic First?**
    - SOC analysts work under **time pressure**.
    - Dynamic analysis provides **faster results** than static.
- **Dynamic Analysis in Practice:**
    - Simply: *“Run the malware and examine its activities.”*
    - While effective, it is **dangerous without proper knowledge** and must be done in controlled environments.

# 3- Tools & Software for Dynamic Malware Analysis

### 1. **Virtualization Software**

- Needed to run malware safely in an isolated environment.
- Keep updated (VM escapes are possible).
- Examples:
    - VMware Workstation / Fusion
    - Oracle VirtualBox

---

### 2. **Utility Software**

- Helps simulate a real user environment (attackers check for these).
- Examples:
    - Microsoft Office
    - Adobe Reader
    - Browsers (Chrome, Firefox)
    - WinRAR
    - Text Editors (Notepad++, Sublime Text)

---

### 3. **Debuggers**

- Used to inspect instructions, alter program flow, and bypass checks.
- Examples:
    - OllyDbg
    - x64dbg
    - WinDbg
    - Radare2

---

### 4. **Network Monitoring Tools**

- Capture and analyze malware network communications.
- Examples:
    - Wireshark
    - Fiddler
    - Burp Suite

---

### 5. **Process Monitoring Tools**

- Track processes spawned by malware.
- Examples:
    - Process Hacker
    - Process Explorer (SysInternals)
    - Procmon (SysInternals)

---

### 6. **File Activity Monitoring Tools**

- Monitor malware’s interaction with the file system.
- Examples:
    - Sysmon

---

### 7. **Other Useful Tools**

- Sysinternals Suite
- CFF Explorer
- PEview
- TriDNet
- BinText
- PEiD
- Regshot
- HashMyFiles

**Pro tip:** Start with a **virtual lab** + **sandbox automation**, then add specialized tools as your analysis becomes more advanced.

# Virtual Machine Setup for Dynamic Malware Analysis

## 1. Install Virtualization Software

- Options: **VMware Workstation** (Windows/Linux), **VMware Fusion** (macOS), **VirtualBox**
- Always **update** to avoid VM escape exploits.

---

## 2. Install Operating System

- Obtain ISO (e.g., Windows 10 64-bit via *MediaCreationTool*).
- In VMware:
    1. **Create New VM** → *Typical (recommended)*
    2. Load ISO file
    3. Name VM (e.g., `Win10 Dynamic Analysis`)
    4. Allocate **60–70 GB disk**
    5. Assign **≥4 GB RAM** (for 64-bit OS)
- Complete OS installation normally.

---

## 3. Install Required Tools

- Add **utilities, debuggers, monitoring tools** (from the toolkit list).
- Make VM resemble a **real user system**.

---

## 4. VM Tweaks for Malware Analysis

### Disable Security Features

- **Windows Defender** (via *Group Policy*:
    
    `Computer Configuration > Administrative Templates > Windows Components > Microsoft Defender Antivirus`).
    
- **Real-time Protection** → *Disabled*.
- **Windows Firewall** → *Turn off*.
- **Auto Updates** → *Disabled* (Group Policy:
    
    `Windows Components > Windows Update > Configure Automatic Updates`).
    

### Configure OS Appearance

- **Rename Hostname & Username** (avoid “sandbox/malware” names).
- **Disable Hidden Extensions** (Explorer → View → uncheck *Hide extensions*).
- **Show Hidden Files & Folders** (Explorer → View → enable *Show hidden files*).
- **Disable ASLR** (Registry:
    
    `HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management` → add `MoveImages=1`).
    

### Mimic End-User System

- Install browsers (Chrome/Firefox).
- Add dummy files in *Documents*, *Downloads*, Desktop.
- Change desktop background.

---

## 5. Network Configuration

- Use **custom/private network** to prevent malware spreading.
- VMware: *VM → Settings → Network Adapter → Custom*.

---

## 6. Take Snapshots

- Before running malware: *VM → Snapshot → Snapshot Manager → Take Snapshot*.
- Use descriptive names (e.g., *Clean Win10 + Tools Installed*).
- Restore snapshot after each test for a clean state.

---

**Result:** A safe, isolated VM that mimics a real user system and is ready for malware execution and monitoring.

# 4-What to Monitor During Dynamic Analysis

When you run malware in a controlled VM, don’t just “watch the screen.” Focus on observable system artefacts and behaviors that reveal how the sample operates: processes, network, registry, files — and how those things change over time.

---

## 1) Process Activities

- **Why:** Malware runs as one or more processes; it may spawn children, inject into other processes, or use legitimate binaries (“living off the land”).
- **What to look for:**
    - New child processes and their parent/child tree.
    - Process start-up user (SYSTEM vs regular user).
    - DLLs loaded by suspicious processes (unexpected or unsigned DLLs).
    - Process injection signs (suspicious thread creation, remote thread, suspicious module loaded into legit process).
- **Tools:** Process Hacker, Process Explorer, Procmon, Task Manager.
- **Quick tip:** Inspect entire lifetime of any legit process that gets injected (e.g., notepad.exe) from the moment injection occurs.

---

## 2) Network Activities

- **Why:** C2, exfiltration, payload downloads and lateral movement use network channels.
- **What to capture:**
    - Domains/IPs contacted (C2, download URLs).
    - Protocols used (HTTP/HTTPS, DNS, SMTP, custom TCP).
    - Suspicious beaconing patterns or persistent periodic connections.
- **Tools:** Wireshark, Fiddler, Burp Suite, Zeek, network sandbox.
- **Quick tips:**
    - Capture a PCAP for the whole run.
    - Note DNS queries and unusual User-Agent strings.
    - Consider turning off outbound internet or route through controlled proxy to prevent harm.

---

## 3) Registry Activities

- **Why:** Malware commonly uses registry keys for persistence or configuration.
- **Common persistence keys to check:**
    - `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
    - `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce`
    - `HKLM\Software\Microsoft\Windows\CurrentVersion\Run`
    - `HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce`
- **Tools:** Regshot (diff before/after), Procmon (Registry events), Regedit, Sysmon (if installed).
- **Quick tip:** Take a registry snapshot *before* running and compare after (Regshot) to find added/modified keys.

---

## 4) File Activities

- **Why:** Malware writes, copies, deletes, or moves files — often to Temp or Startup for persistence.
- **Important locations:**
    - `%TEMP%` — staging, unpacked payloads.
    - `shell:startup` and `shell:common startup` — persistence shortcuts.
    - ProgramData, AppData, Windows\System32 (for stealthy placement).
- **Tools:** Procmon (File System events), Sysmon, Process Explorer, simple directory watches.
- **Quick tips:**
    - Use `%TEMP%` and `shell:startup` to quickly jump to monitored folders.
    - Save suspicious files (dump) for offline static analysis (hash them).

---

## 5) General Best Practices & Extras

- **Capture everything:** Take a memory dump, full process dumps, PCAP, Procmon logs, and a snapshot of your VM prior to execution.
- **Correlate artifacts:** Cross-check process->file->network->registry links to map behavior (which process made which change).
- **Triage priority:** For fast SOC triage, network C2 and spawned child processes are high priority.
- **Containment:** Route malware traffic through a controlled proxy/sandbox or disable external connectivity to prevent spread.
- **Indicators to extract:** Filenames, hashes (MD5/SHA256), domains/IPs, registry keys, mutexes, service names, scheduled tasks.
- **Preserve evidence:** Store logs, screenshots, and dumped binaries with metadata (time, VM snapshot id, analyst name).

---

## 6) Quick Command & Filter Examples

- Open Temp: `Win + R` → `%TEMP%`
- Open Startup: `Win + R` → `shell:startup` (user); `shell:common startup` (all users)
- Procmon filters to start with: `Process Name` `is` `<suspect.exe>`; `Operation` `contains` `Reg` / `WriteFile` / `CreateFile`
- Wireshark basic filters: `http` (HTTP traffic), `dns` (DNS), `tcp.port == 443` (TLS) — capture full traffic and inspect payloads.

---

## Short Checklist (run this for each sample)

1. Snapshot VM clean state.
2. Capture baseline (Regshot 1, Procmon baseline).
3. Start packet capture (Wireshark) + Procmon + Process Explorer.
4. Run sample.
5. Observe: new processes, child trees, file writes, registry changes, network connections.
6. Stop captures; take memory & process dumps.
7. Compare Regshot (before/after) and analyze PCAP.
8. Restore VM snapshot for next sample.

# 5- Dynamic Malware Analysis #1 — Organized Report

## 1) Summary

**AnyRun report:** https://app.any.run/tasks/dc098d24-a518-45fe-8dbb-c4bc8b31a67a

**Sample name:** `e-Archive Dekont.exe`

**Alternate/installed filename:** `VbxFiQYCyFDgGL.exe` (copied to roaming)

**Type (determined):** Information stealer / dropper (steals browser & mail client data; persists via Task Scheduler)

**MD5:** `7a0093c743fc33a5e111f2fec269f79b`

**SHA-256:** `722ef401e5cbb067c5c33faa402774d3c75ef08e0c8cc4d7e66a9cfa53684088`

**C2 / Callback:** `http[:]//5gw4d[.]xyz/PL341/index.php` (HTTP)

---

## 2) Preparation (what to run before execution)

Start monitoring tools **before** executing sample so all actions are captured:

- **Process monitoring:** Process Hacker (or Process Explorer)
- **Process / file / registry / network tracing:** Procmon (Sysinternals) — enable full capture, use “Show Process Tree” later
- **Registry diff:** RegShot — take **1st shot** before execution
- **Network capture/inspection:** Wireshark and Fiddler (Fiddler sufficient for HTTP analysis)
- Use an **isolated VM** snapshot and no host bridging.

---

## 3) Execution (what was done)

1. Start Process Hacker, Procmon, RegShot (1st shot), Wireshark/Fiddler.
2. Execute `e-Archive Dekont.exe` by double-clicking on desktop.
3. Allow runtime for activity, then take RegShot **2nd shot** and stop captures.

---

## 4) Process Activity (observations & analysis)

- **Initial PID:** `9076` (launched sample)
- **Observed child processes:** `schtasks.exe` (PID `4800`) then a second malware instance `VbxFiQYCyFDgGL.exe` (PID `7944`)
- **Behavior:** The sample invoked `schtasks.exe` to create a scheduled task, then launched/copied its payload (`VbxFiQYCyFDgGL.exe`).
- **Persistence technique:** Using Task Scheduler (via `schtasks.exe`) to run at logon.

---

## 5) Task Scheduler / Persistence Details

- **Scheduled task name:** `Updates\VbxFiQYCyFDgGL`
- **Task XML:** originally written to `C:\Users\Amanda\AppData\Local\Temp\tmpCCF2.tmp` (file deleted after creation)
- **Trigger:** Runs **At log on** (ensures persistence across reboots)
- **Action:** Runs `VbxFiQYCyFDgGL.exe` from AppData\Roaming.

---

## 6) Network Activity (observations & analysis)

- **Observed domain (Fiddler):** `5gw4d[.]xyz`
- **Observed URL / C2:** `http[:]//5gw4d[.]xyz/PL341/index.php` (HTTP)
- **Behavior:** C2 communication over HTTP — likely command retrieval and exfiltration.

---

## 7) Registry Activity (observations)

- Malware enumerates keys under:
    - `HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall`
    - Purpose: enumerate installed applications (reconnaissance for targeted data theft or compatibility checks).

---

## 8) File Activity (observations)

- Malware writes a copy of itself to:
    - `C:\Users\Amanda\AppData\Roaming\VbxFiQYCyFDgGL.exe`
- Hash of that copied file matches the original sample (self-replication/copy).
- Reads files related to user data and application stores (targets for credential harvesting), specifically browser and mail client storage (Chrome, Firefox, Thunderbird).

---

## 9) Behavior / Capabilities Observed

- Copies itself to AppData\Roaming (persistence + stealth).
- Creates a scheduled task to run at logon (persistence).
- Performs reconnaissance of installed applications via Uninstall registry key.
- Communicates with a remote HTTP C2 (`5gw4d[.]xyz/PL341/index.php`).
- Steals sensitive data from applications: **Chrome, Firefox, Thunderbird** (passwords, cookies, saved data).
- Acts as an information stealer (not primarily a keylogger from provided data).

---

## 10) Final Result / Findings

- **Malware family / role:** Information stealer (dropper/stealer)
- **Key behaviors:** self-copy to roaming, scheduled-task persistence, HTTP C2 communication, harvesting browser/mail credentials.
- **Artifacts / IOCs:** listed below.

---

## 11) Indicators of Compromise (IOCs)

- **Original filename:** `e-Archive Dekont.exe`
- **Copied filename:** `VbxFiQYCyFDgGL.exe` (in `%AppData%\Roaming\`)
- **MD5:** `7a0093c743fc33a5e111f2fec269f79b`
- **SHA256:** `722ef401e5cbb067c5c33faa402774d3c75ef08e0c8cc4d7e66a9cfa53684088`
- **Domain / C2:** `5gw4d[.]xyz`
- **URL:** `http[:]//5gw4d[.]xyz/PL341/index.php`
- **Registry keys enumerated:** `HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall`
- **Persistence artifact:** Scheduled Task `Updates\VbxFiQYCyFDgGL` (trigger: At log on)

---

## 12) Suggested Timeline (concise)

1. 00:00 — Start Procmon, Process Hacker, RegShot (1st shot), Fiddler/Wireshark.
2. 00:01 — Execute `e-Archive Dekont.exe` (PID 9076).
3. 00:02 — `schtasks.exe` invoked (PID 4800) to create scheduled task `Updates\VbxFiQYCyFDgGL`.
4. 00:03 — Malware copies itself to `%AppData%\Roaming\VbxFiQYCyFDgGL.exe` (PID 7944).
5. 00:04 — `VbxFiQYCyFDgGL.exe` communicates with `http[:]//5gw4d[.]xyz/PL341/index.php`.
6. 00:05 — Procmon/RegShot/Wireshark captures show registry enumeration and file reads targeting browser/mail data.

# 6- Dynamic Malware Analysis #2 — Organized Report

## 1) Summary

**AnyRun report:** https://app.any.run/tasks/1c8f0ad5-c14b-4cbe-aafd-17d03c1f4740?p=627af042772f69160e06ad9e

**Sample name:** `Sales Order Sheet.pdf.exe`

**Type (determined):** Snake Keylogger (exfiltrates credentials via SMTP)

**MD5:** `411019bcb582ef6e3dab080d99925b4b`

**SHA-256:** `f381e338212079c3a03fbbb532cdec44b1d27db03e8cc4c47408ef038885d934`

**High-level behavior:** spawns `regsvcs.exe` child, queries public IP (checkip.dyndns.org), harvests credentials (browser data), and exfiltrates via SMTP to attacker email using `skyshine[.]com[.]my:25`.

---

## 2) Preparation (what to run before execution)

- Start monitoring tools **before** running sample:
    - **Process monitoring:** Process Hacker (or Process Explorer)
    - **File/registry/process/network tracing:** Procmon (Sysinternals)
    - **Registry diff:** RegShot — take **1st shot** before execution
    - **Network capture:** Wireshark (and optional Fiddler for HTTP/S inspection)
- Ensure isolated VM with snapshots and no host bridging.

---

## 3) Execution (what was done)

1. Start Process Hacker, Procmon, RegShot (1st shot), Wireshark, Fiddler.
2. Execute `Sales Order Sheet.pdf.exe` by clicking on the desktop.
3. Allow sufficient runtime for activity, then take RegShot **2nd shot** and stop captures.

---

## 4) Process Activity (observations & analysis)

- **Parent PID (first launched):** `8780` (sample process)
- **Child PID observed:** `7100` named `regsvcs.exe`
    - Path shown as: `C:\Windows\Microsoft.NET\Framework\v4.0.30319\RegSvcs.exe`
    - Verified hash of that path against VirusTotal showed Microsoft-signed binary (legitimate file exists at that path).
- **Suspicion:** `regsvcs.exe` was created by the malware (malware-created child process). Legitimate Microsoft binary may be *used* by the attacker via:
    - Code injection / process hollowing / reflective DLL injection, OR
    - “Living-off-the-land” technique (using legitimate binary to perform attacker tasks).
- **Evidence required:** network/registry/file activity from `7100` PID supports malicious use.

---

## 5) Network Activity (observations & analysis)

- **Requests observed (Fiddler):**
    - Query to `checkip.dyndns.org` — used to obtain public IP address.
- **SMTP traffic (Wireshark):**
    - Outbound SMTP connection to `skyshine[.]com[.]my` on port `25`.
    - Email sent **to** `graceunlimited153@gmail[.]com`.
    - Email subject/body contained `Pc Name: admin | Snake Keylogger`.
    - Multiple attachments named `Password.txt`, `User.txt` encoded in base64 — decoded to reveal credential data.
- **Conclusion:** The malware is exfiltrating harvested credentials and IP to attacker-controlled address via SMTP (using a hijacked or attacker-controlled mail server).

---

## 6) Registry / File Activities

- RegShot (before/after) indicated registry changes consistent with persistence or configuration (specific keys not listed in provided text — include when available).
- Procmon filtered to PIDs `8780` and `7100` shows file reads/writes and registry modifications performed by those PIDs (use Procmon filter: `PID == 8780 OR PID == 7100`).

---

## 7) Evidence linking process → malicious activity

- `regsvcs.exe` (PID 7100) is making network requests it should not (querying public IP and sending SMTP mail).
- SMTP mail contents and attachments contain stolen credentials and system identifier.
- Therefore: although `regsvcs.exe` file on disk is legitimate Microsoft binary, the instance running under PID 7100 is controlled by the malicious sample (likely via injection or by launching a legitimate binary with malicious arguments/payload).

---

## 8) Final Result / Findings

- **Malware family:** Snake Keylogger
- **Capabilities observed:**
    - Steals browser credentials / user/password information.
    - Retrieves victim public IP via `checkip.dyndns.org`.
    - Exfiltrates stolen data via SMTP to `graceunlimited153@gmail[.]com` through `skyshine[.]com[.]my:25`.
    - Uses or spawns `regsvcs.exe` to perform network/exfiltration tasks.
- **Key Indicators (IOCs):**
    - File hashes: MD5 **`411019bcb582ef6e3dab080d99925b4b`**, SHA256 **`f381e338212079c3a03fbbb532cdec44b1d27db03e8cc4c47408ef038885d934`**
    - Filenames: `Sales Order Sheet.pdf.exe`
    - Domains: `checkip.dyndns.org`, `skyshine[.]com[.]my` (observed SMTP server)
    - Email recipient: `graceunlimited153@gmail[.]com`
    - Processes: parent PID `8780`, child `regsvcs.exe` PID `7100`

---

## 9) Suggested Timeline (concise)

- The time wasn't specified in the activity, so I used seconds and organized the activity based on the report
1. 00:00 — Start Procmon, Process Hacker, RegShot (1st shot), Wireshark, Fiddler.
2. 00:01 — Execute `Sales Order Sheet.pdf.exe` (PID 8780).
3. 00:02 — Sample spawns child PID 7100 `regsvcs.exe`.
4. 00:03 — `regsvcs.exe` queries `checkip.dyndns.org`.
5. 00:04 — `regsvcs.exe` connects to `skyshine[.]com[.]my:25` and sends SMTP email containing base64 attachments (`Password.txt`, `User.txt`).
6. 00:05 — RegShot (2nd shot) taken; captures show registry changes; Procmon/Wireshark captures stopped.

---

## 10) Actionable Recommendations / Next Steps

- **Containment**
    - Isolate the infected host from network immediately.
    - Capture full memory image and disk image for forensic preservation.
- **Eradication**
    - Kill malicious processes (note: terminating may lose volatile evidence — capture memory first).
    - Remove persistence entries (based on RegShot diffs).
    - Restore affected files from known-good backups.
- **Remediation**
    - Reset credentials for any accounts found in exfiltrated data (especially those in `Password.txt`, `User.txt`).
    - Patch and harden systems; remove or reimage VM if unsure of compromise completeness.
- **Detection**
    - Block outbound SMTP to unknown mail servers (strict egress rules).
    - Add signatures/alerts for connections to `skyshine[.]com[.]my` and queries to `checkip.dyndns.org`.
    - Monitor for unexpected child processes of `explorer.exe` or unusual uses of `regsvcs.exe`.
- **Reporting**
    - Report malicious domain to hosting provider / registrar and optionally to law enforcement / CERT.
- **Prevention**
    - Educate users to be suspicious of double-extension files like `.pdf.exe`.
    - Enforce least privilege so users do not run malware with administrative rights.

---

## 11) Artifacts / IOC Quick Reference

- **File:** `Sales Order Sheet.pdf.exe`
- **MD5:** `411019bcb582ef6e3dab080d99925b4b`
- **SHA256:** `f381e338212079c3a03fbbb532cdec44b1d27db03e8cc4c47408ef038885d934`
- **Processes:** `8780` (parent), `7100` → `regsvcs.exe`
- **Domains:** `checkip.dyndns.org`, `skyshine[.]com[.]my`
- **Email:** `graceunlimited153@gmail[.]com`
- **Exfiltration protocol:** SMTP (port 25)
- **Attachments observed:** `Password.txt`, `User.txt` (base64 encoded)

# 7- Malware Not Showing Activity – Quick Lab Checklist

**Wait**

- Give it at least **3–5 minutes** (malware may use `sleep` to bypass sandboxes).

**Run with Admin Privileges**

- Re-execute as **Administrator**; many samples exit silently without privileges.

**Adjust System Settings**

- Change **OS language / locale / timezone** to match possible target.
- Modify **screen resolution**.

**Change Network Environment**

- Use a **VPN / proxy** to test from another country.
- Pick country based on **email language** or clues in static analysis.

**User Interaction**

- While running, **move the mouse, type, open programs**, etc. (some malware waits for human activity).

**Other Tricks**

- Run from a **different directory** (e.g., not Desktop).
- Cross-check with **static analysis** to see if IP / region / environment checks are present.

**Important**: Always test inside an **isolated VM / sandbox** with no connection to your host system.
